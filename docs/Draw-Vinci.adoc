= Draw-Vinci
Andreas Hofschweiger; Kelve T. Henrique <kelvehenrique@hotmail.com>
:Date: 2018 Mai 18
:description: Documenting Draw-Vinci Makeblock XY_Plotter Project
:source-highlighter: coderay
:listing-caption: Listing
:imagesdir: img
:toc: left

== Introduction

[#portErrors]
.MakeBlock XY Plotter
image::plotter.jpeg[]

=== Project Description

[quote]
Design and develop both a multi-threaded PC GUI application as well as an XMC RTOS application using uCOS-III to control a MakeBlock XY plotter as shown below. In
either case you can select a file format (G-Code, Excellon, HPGL or SVG — see below) to determine the content that shall be drawn using the machine. As an
alternative you could devise a simple drawing application to do the same.

== GUI

[#GUI]
.Main Window
image::gui_main.png[]

=== Functionalities

==== Draw Tab

===== Tools

[cols="^.1s,<.3m"]
|===
| Eraser     | Increase opacity of item clicked upon. If clicking until item dissapear, it will make the item invisible.
| Freehand   | Permits to draw in a free style.
| Line       | Used to draw lines.
| Square     | Used to draw squares.
| Rectangle  | Used to draw rectangles.
| Polygone   | Used to draw polygones.
| Select     | Permits to select items on canvas. When selected, an item can be removed clicking 'del' on the keyboard.
| Magnifier  | Permits zoom in using a user-defined rectangle. With the left button of the mouse, the user can define a rectangle to zoom in and with the right click of
the mouse, the user can zoom out completely to the default scale.
| Text       | Used to write a text on canvas. Although this still cannot be plotted!
| Circle     | Used to draw circles.
| Ellipse    | Used to draw ellipses.
| Import     | Used to import to canvas the current image on the nextSVGButton.

|===

Key Combinations::
    Ctrl+N:::
        Clear canvas for new work.
    Ctrl+O:::
        Opens new SVG file.
    Ctrl+S:::
        Save current canvas.
    Ctrl+Shift+S:::
        Save current canvas with a new name.
    Ctrl+?:::
        Opens about dialog.
    Ctrl+Z:::
        Remove last added item from canvas. 
    Del:::
        Remove selected item from canvas.

==== Control Tab

===== Connection

PromptEdit::
    Terminal:::
        Say something about terminal

===== Mode

Manual::
    Directional & Pen Buttons:::
        Say something about manual mode

Auto:::
    Flow Control Buttons:::
        Say something about auto mode

== XMC4500

.Servo Motor Function
video::servoMotor.mp4[width=640]


=== Formats supported

=== Images

Here is the subset of SVG parameters supported and recognised when opening, importing or saving:

[cols="^.1s,<.3m"]
|===
| width    | Width of display
| height   | Height of display
| viewbox  | Dimensions of view
| rect     | Rectangles
| ellipse  | Ellipses
| circle   | Circles
| polyline | Group of lines
| polygone | Polygones
| path     | Paths
| text     | Texts

|===

[NOTE]
====
Colors not supported!

====

== Communication

The communication between GUI and the uC XMC4500 happens through UART, using the followins scheme as protocol:

[protocol_frame]
.Protocol Frame
image::frame.png[Frame of Protocol]

Where:

[lowerroman]
 . *#*: Beginn of message;
 . *G COMMAND*: One of the supported G-Code commands [vide following section];
 . *ARG{1}*: a apropriate argument to the G command;
 . *ARG{2}*: another apropriate argument to the G command;
 . *$*: End of message;

[NOTE]
====
The number of arguments in a message should conform to the G command

====

=== G-CODE Specification

Here is the subset of G-CODE currently supported

[cols="^.1s,<.3m"]
|===
|G28 | Perform homing routine
|G00 | Rapid positioning
|G90 | Absolute mode positioning
|G91 | Relative mode positioning
|G01 | Linear interpolation
|G02 | Circular interpolation

|===

Possible commands:

. #G28$             : Plotter will move to the top-left side.
. #G00:XA:YB$       : Plotter will move to the spot (A, B) as fast as reasonable.
. #G90$             : Plotter will interprete all subsequent commands as absolute movements.
. #G91$             : Plotter will interprete all subsequent commands as relative to the current position.
. #G01:XA:YB$       : Plotter will move linearly to the point (A, B) - relative or absolute.
. #G01:ZK$          : Plotter's pen will lift up (K = 1) or drop (K = 0).
. #G02:XA:YB:IC:JD$ : Plotter will move in a circular way to the point (A, B), taking as reference the center at (A+C, B+D) - relative or absolute.

=== Error Table

[#portErrors]
.Possible errors codes by connection
image::portErrorsTable.png[]

=== Building the App
The software comprising this project was built and tested using the following environment:

Hardware::
    Plotter:::
        . MakeBlock XY_Plotter
    Microcontroller:::
        . Infineon XMC4500
    Interface:::
        . UART TTL
        . USB

Operating Systems::
    Linux:::
        . Ubuntu 16.04
            * Desktop
        . Ubuntu 17.04
            * Desktop
        . Ubuntu 18.04
            * Desktop

Framework & Tools::
    GUI:::
        . PyQt5 + Qt
            .. Qt Designer
            .. pyuic5
    Firmware:::
        . Micrium
            .. uCOS III
        . Infineon
            .. XMCLIB
    Documentation:::
        . Asciidoctor
            .. asciidoctor-pdf

Dependencies::
    Python3:::
        . PyQt5
        . pyudev
    arm-none-eabi:::
        . https://launchpad.net/gcc-arm-embedded/5.0/5-2016-q3-update/+download/gcc-arm-none-eabi-5_4-2016q3-20160926-linux.tar.bz2
    SEGGER J-Link:::
        . https://www.segger.com/downloads/jlink/#J-LinkSoftwareAndDocumentationPack

